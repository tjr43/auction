<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¨ë¼ì¸ ê²½ë§¤ ì‹œìŠ¤í…œ</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS (ìŠ¤íƒ€ì¼ë§ ê°„ì†Œí™”) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#1a1a1a',
                        panel: '#2d2d2d',
                        accentA: '#ff6b6b',
                        accentB: '#4dabf7',
                        highlight: '#ffd43b'
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #1a1a1a; color: #e0e0e0; overflow: hidden; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #ffd43b; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ (ì—­í•  ì„ íƒ) -->
    <div id="login-modal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center">
        <div class="bg-panel p-8 rounded-xl max-w-md w-full text-center border border-gray-700 shadow-2xl">
            <h2 class="text-3xl font-bold text-highlight mb-6">ğŸ² ì˜¨ë¼ì¸ ê²½ë§¤ ì…ì¥</h2>
            <div class="space-y-4">
                <button onclick="selectRole('A')" class="w-full py-4 bg-accentA/20 hover:bg-accentA/40 border-2 border-accentA text-accentA rounded-lg font-bold transition flex justify-between px-6 items-center">
                    <span>ğŸ”´ AíŒ€ íŒ€ì¥ìœ¼ë¡œ ì…ì¥</span>
                    <span id="status-a" class="text-xs bg-black/50 px-2 py-1 rounded">ëŒ€ê¸°ì¤‘</span>
                </button>
                <button onclick="selectRole('B')" class="w-full py-4 bg-accentB/20 hover:bg-accentB/40 border-2 border-accentB text-accentB rounded-lg font-bold transition flex justify-between px-6 items-center">
                    <span>ğŸ”µ BíŒ€ íŒ€ì¥ìœ¼ë¡œ ì…ì¥</span>
                    <span id="status-b" class="text-xs bg-black/50 px-2 py-1 rounded">ëŒ€ê¸°ì¤‘</span>
                </button>
                <div class="h-px bg-gray-600 my-4"></div>
                <button onclick="selectRole('spectator')" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-bold transition">
                    ğŸ‘€ ê´€ì „ìë¡œ ì…ì¥
                </button>
            </div>
            <p class="mt-6 text-xs text-gray-500">* Firebase ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
        </div>
    </div>

    <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
    <header class="bg-black border-b border-gray-700 h-14 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-gavel text-highlight"></i>
            <span class="font-bold text-lg">Auction Online</span>
        </div>
        <div class="flex items-center gap-4 text-sm">
            <span id="my-role-display" class="px-3 py-1 rounded bg-gray-800 border border-gray-600">ì ‘ì†ì¤‘...</span>
            <button onclick="resetGame()" class="text-red-400 hover:text-red-300 text-xs underline">âš ï¸ ê²Œì„ ì´ˆê¸°í™”</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- ì™¼ìª½: ëŒ€ê¸°ì‹¤ (ì´ë¯¸ì§€ ê´€ë¦¬) -->
        <div class="w-1/5 bg-panel border-r border-gray-700 flex flex-col p-4">
            <h3 class="font-bold mb-4 flex justify-between items-center">
                <span>ğŸ“‚ ëŒ€ê¸°ì‹¤</span>
                <span id="waiting-count" class="text-xs bg-gray-700 px-2 py-1 rounded">0</span>
            </h3>
            
            <!-- ì—…ë¡œë“œ ë²„íŠ¼ (ëˆ„êµ¬ë‚˜ ê°€ëŠ¥í•˜ê±°ë‚˜ íŠ¹ì •ì¸ë§Œ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •) -->
            <div class="mb-4">
                <input type="file" id="fileInput" multiple accept="image/*" class="hidden" onchange="uploadImages(this.files)">
                <button onclick="document.getElementById('fileInput').click()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm transition">
                    <i class="fa-solid fa-cloud-arrow-up"></i> ì‚¬ì§„ ì¶”ê°€
                </button>
            </div>

            <div id="waiting-grid" class="flex-1 overflow-y-auto grid grid-cols-2 gap-2 content-start pr-1">
                <!-- ì´ë¯¸ì§€ ì¸ë„¤ì¼ -->
            </div>
        </div>

        <!-- ì¤‘ì•™: ê²½ë§¤ ìŠ¤í…Œì´ì§€ -->
        <div class="w-1/2 bg-dark flex flex-col relative">
            <!-- ë©”ì¸ í™”ë©´ -->
            <div class="flex-1 flex flex-col justify-center items-center p-8">
                <div class="relative w-80 h-80 bg-black rounded-2xl border-4 border-gray-600 shadow-2xl overflow-hidden flex justify-center items-center mb-6">
                    <img id="main-display" src="" class="w-full h-full object-cover hidden">
                    <div id="placeholder-text" class="text-gray-500 text-center">
                        <i class="fa-solid fa-image text-4xl mb-2"></i><br>ê²½ë§¤ ëŒ€ê¸°ì¤‘
                    </div>
                    <!-- ë£°ë › ì• ë‹ˆë©”ì´ì…˜ìš© ì˜¤ë²„ë ˆì´ -->
                    <div id="roulette-overlay" class="absolute inset-0 bg-black flex justify-center items-center hidden z-10">
                        <img id="roulette-img" class="w-full h-full object-cover opacity-80">
                    </div>
                </div>

                <div class="text-center space-y-2">
                    <div class="text-gray-400 text-sm">í˜„ì¬ ê°€ê²©</div>
                    <div class="text-5xl font-bold text-highlight drop-shadow-lg"><span id="current-price">0</span>ì›</div>
                    <div id="auction-status" class="h-6 text-sm text-gray-500">ì‹œì‘ ì „</div>
                </div>

                <!-- ê²½ë§¤ ì‹œì‘ ë²„íŠ¼ (ì¡°ê±´ë¶€ í‘œì‹œ) -->
                <button id="btn-start" onclick="startAuction()" class="mt-8 px-8 py-3 bg-highlight text-black font-bold rounded-full hover:bg-yellow-400 transition hidden shadow-lg shadow-yellow-500/20">
                    START AUCTION
                </button>
            </div>

            <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ (í•˜ë‹¨) -->
            <div class="h-48 border-t border-gray-700 flex">
                <!-- AíŒ€ ì»¨íŠ¸ë¡¤ -->
                <div id="ctrl-a" class="flex-1 bg-gradient-to-t from-red-900/20 to-transparent p-4 flex flex-col items-center justify-center opacity-30 pointer-events-none transition-all duration-300">
                    <h4 class="text-accentA font-bold mb-2">TEAM A</h4>
                    <input type="number" id="input-a" class="bg-gray-800 border border-gray-600 rounded p-2 w-32 text-center mb-2 text-white" placeholder="ê¸ˆì•¡">
                    <div class="flex gap-2">
                        <button onclick="placeBid('A')" class="px-4 py-2 bg-accentA text-white rounded font-bold hover:brightness-110">ì…ì°°</button>
                        <button onclick="passTurn('A')" class="px-4 py-2 bg-gray-600 text-white rounded font-bold hover:bg-gray-500">í¬ê¸°</button>
                    </div>
                </div>
                <!-- BíŒ€ ì»¨íŠ¸ë¡¤ -->
                <div id="ctrl-b" class="flex-1 bg-gradient-to-t from-blue-900/20 to-transparent p-4 flex flex-col items-center justify-center opacity-30 pointer-events-none transition-all duration-300">
                    <h4 class="text-accentB font-bold mb-2">TEAM B</h4>
                    <input type="number" id="input-b" class="bg-gray-800 border border-gray-600 rounded p-2 w-32 text-center mb-2 text-white" placeholder="ê¸ˆì•¡">
                    <div class="flex gap-2">
                        <button onclick="placeBid('B')" class="px-4 py-2 bg-accentB text-white rounded font-bold hover:brightness-110">ì…ì°°</button>
                        <button onclick="passTurn('B')" class="px-4 py-2 bg-gray-600 text-white rounded font-bold hover:bg-gray-500">í¬ê¸°</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì •ë³´ ë° ì±„íŒ… -->
        <div class="w-3/10 bg-panel border-l border-gray-700 flex flex-col p-4 w-[30%]">
            <!-- íŒ€ í˜„í™© -->
            <div class="space-y-4 mb-4">
                <div class="bg-dark p-3 rounded-lg border-l-4 border-accentA">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-accentA">Team A</span>
                        <span id="money-a" class="font-mono">1000ì›</span>
                    </div>
                    <div id="roster-a" class="flex flex-wrap gap-1 h-16 overflow-y-auto content-start"></div>
                </div>
                <div class="bg-dark p-3 rounded-lg border-l-4 border-accentB">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-accentB">Team B</span>
                        <span id="money-b" class="font-mono">1000ì›</span>
                    </div>
                    <div id="roster-b" class="flex flex-wrap gap-1 h-16 overflow-y-auto content-start"></div>
                </div>
            </div>

            <!-- ì±„íŒ… -->
            <div class="flex-1 bg-black rounded-lg border border-gray-700 flex flex-col overflow-hidden">
                <div id="chat-box" class="flex-1 overflow-y-auto p-3 text-sm space-y-1"></div>
                <form onsubmit="sendChat(event)" class="flex border-t border-gray-700">
                    <input type="text" id="chat-input" class="flex-1 bg-transparent p-3 outline-none text-white placeholder-gray-600" placeholder="ì±„íŒ… ì…ë ¥...">
                    <button type="submit" class="px-4 bg-gray-800 hover:bg-gray-700 text-gray-300 transition">ì „ì†¡</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (ëª¨ë“ˆ ë°©ì‹ ì•„ë‹˜, CDN ë°©ì‹ ì‚¬ìš©) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, arrayUnion, arrayRemove, collection, addDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // 1. Firebase ì„¤ì • (ë³¸ì¸ì˜ ì„¤ì •ê°’ìœ¼ë¡œ êµì²´ í•„ìˆ˜!)
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAYyjK1qwPObsSXFSEmnye64iTFvcIY1Lg",
            authDomain: "auction-dfc5c.firebaseapp.com",
            projectId: "auction-dfc5c",
            storageBucket: "auction-dfc5c.firebasestorage.app",
            messagingSenderId: "422510640786",
            appId: "1:422510640786:web:7fdd804b61ac401408b04b"
        };
        

        // -------------------------------------------------------------------------

        // ì•± ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ì „ì—­ ìƒíƒœ
        let myRole = null; // 'A', 'B', 'spectator'
        let myUid = null;
        let gameState = {};
        
        // Firestore ê²½ë¡œ ìƒìˆ˜ (ê·œì¹™ ì¤€ìˆ˜)
        // ì‹¤ì œ ì‚¬ìš© ì‹œ 'default-app-id' ë¶€ë¶„ì„ ìœ ë‹ˆí¬í•œ ë°© ì´ë¦„ìœ¼ë¡œ ë°”ê¾¸ë©´ ì—¬ëŸ¬ ë°© ìƒì„± ê°€ëŠ¥
        const APP_ID = 'auction-room-01'; 
        const PUBLIC_PATH = `artifacts/${APP_ID}/public/data`;
        
        // =========================================================================
        // 2. ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ ë¡œì§
        // =========================================================================
        async function init() {
            try {
                const cred = await signInAnonymously(auth);
                myUid = cred.user.uid;
                console.log("Logged in:", myUid);

                // ë¦¬ìŠ¤ë„ˆ ì—°ê²°
                setupListeners();

            } catch (e) {
                console.error("Auth Error:", e);
                alert("Firebase ì—°ê²° ì‹¤íŒ¨. ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
            }
        }
        init();

        window.selectRole = async (role) => {
            // ì—­í•  ì ìœ  í™•ì¸ ë¡œì§ (ê°„ë‹¨í•˜ê²Œ êµ¬í˜„)
            if (role === 'A' && gameState.teams?.A?.leader && gameState.teams.A.leader !== myUid) {
                alert("AíŒ€ì¥ì€ ì´ë¯¸ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤."); return;
            }
            if (role === 'B' && gameState.teams?.B?.leader && gameState.teams.B.leader !== myUid) {
                alert("BíŒ€ì¥ì€ ì´ë¯¸ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤."); return;
            }

            myRole = role;
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('login-modal').classList.add('hidden');
            const roleName = role === 'A' ? 'ğŸ”´ AíŒ€ì¥' : (role === 'B' ? 'ğŸ”µ BíŒ€ì¥' : 'ğŸ‘€ ê´€ì „ì');
            document.getElementById('my-role-display').innerText = roleName;

            // DBì— ì—­í•  ë“±ë¡ (íŒ€ì¥ì¸ ê²½ìš°)
            if (role === 'A') updateDoc(doc(db, PUBLIC_PATH, 'teams'), { "A.leader": myUid });
            if (role === 'B') updateDoc(doc(db, PUBLIC_PATH, 'teams'), { "B.leader": myUid });

            // ì‹œìŠ¤í…œ ë©”ì‹œì§€
            sendSystemMessage(`${roleName}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
        };

        // =========================================================================
        // 3. ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” (Listeners)
        // =========================================================================
        function setupListeners() {
            // (1) ê²Œì„ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ
            onSnapshot(doc(db, PUBLIC_PATH, 'game_state'), (snap) => {
                if (!snap.exists()) {
                    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                    resetGame();
                    return;
                }
                const data = snap.data();
                gameState.status = data.status; // 'idle', 'rolling', 'auction', 'finished'
                gameState.currentPrice = data.currentPrice;
                gameState.currentBidder = data.currentBidder;
                gameState.currentItem = data.currentItem;
                
                renderGameUI(data);
                handleRouletteEffect(data);
            });

            // (2) íŒ€ ì •ë³´ ë¦¬ìŠ¤ë„ˆ
            onSnapshot(doc(db, PUBLIC_PATH, 'teams'), (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                gameState.teams = data;
                
                // ëˆ UI
                document.getElementById('money-a').innerText = (data.A.money || 0) + 'ì›';
                document.getElementById('money-b').innerText = (data.B.money || 0) + 'ì›';

                // ë¡œìŠ¤í„° UI
                renderRoster('roster-a', data.A.roster);
                renderRoster('roster-b', data.B.roster);

                // ë¡œê·¸ì¸ ëª¨ë‹¬ ìƒíƒœ í‘œì‹œ
                const statusA = document.getElementById('status-a');
                const statusB = document.getElementById('status-b');
                if(statusA) statusA.innerText = data.A.leader ? 'ì ‘ì†ì¤‘' : 'ëŒ€ê¸°ì¤‘';
                if(statusB) statusB.innerText = data.B.leader ? 'ì ‘ì†ì¤‘' : 'ëŒ€ê¸°ì¤‘';
                if(statusA) statusA.className = `text-xs px-2 py-1 rounded ${data.A.leader ? 'bg-green-600' : 'bg-gray-600'}`;
                if(statusB) statusB.className = `text-xs px-2 py-1 rounded ${data.B.leader ? 'bg-green-600' : 'bg-gray-600'}`;

                // ê²½ë§¤ ì‹œì‘ ë²„íŠ¼ í™œì„±í™” ì²´í¬ (ë‘˜ ë‹¤ ì ‘ì† & idle ìƒíƒœì¼ ë•Œ)
                const bothReady = data.A.leader && data.B.leader;
                const btnStart = document.getElementById('btn-start');
                
                if (bothReady && gameState.status === 'idle') {
                    btnStart.classList.remove('hidden');
                } else {
                    btnStart.classList.add('hidden');
                }
            });

            // (3) ëŒ€ê¸°ì‹¤ ì´ë¯¸ì§€ ë¦¬ìŠ¤ë„ˆ
            const qImages = query(collection(db, PUBLIC_PATH, 'images'), orderBy('createdAt'));
            onSnapshot(qImages, (snap) => {
                const grid = document.getElementById('waiting-grid');
                grid.innerHTML = '';
                gameState.images = []; // ë¡œì»¬ ì €ì¥
                
                snap.forEach(docSnap => {
                    const imgData = docSnap.data();
                    gameState.images.push(imgData.data); // Base64 string
                    
                    const img = document.createElement('img');
                    img.src = imgData.data;
                    img.className = "w-full aspect-square object-cover rounded border border-gray-600 bg-black";
                    grid.appendChild(img);
                });
                document.getElementById('waiting-count').innerText = gameState.images.length;
            });

            // (4) ì±„íŒ… ë¦¬ìŠ¤ë„ˆ
            const qChat = query(collection(db, PUBLIC_PATH, 'chat'), orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(qChat, (snap) => {
                const box = document.getElementById('chat-box');
                box.innerHTML = '';
                const messages = [];
                snap.forEach(d => messages.push(d.data()));
                messages.reverse().forEach(msg => {
                    const div = document.createElement('div');
                    if (msg.type === 'system') {
                        div.className = "text-yellow-500 italic text-xs text-center my-2";
                        div.innerText = `ğŸ“¢ ${msg.text}`;
                    } else {
                        const color = msg.role === 'A' ? 'text-accentA' : (msg.role === 'B' ? 'text-accentB' : 'text-gray-400');
                        div.innerHTML = `<span class="font-bold ${color}">${msg.sender}:</span> ${msg.text}`;
                    }
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // =========================================================================
        // 4. UI ë Œë”ë§ ë° ë¡œì§
        // =========================================================================
        function renderGameUI(state) {
            const priceEl = document.getElementById('current-price');
            const statusEl = document.getElementById('auction-status');
            const mainImg = document.getElementById('main-display');
            const placeholder = document.getElementById('placeholder-text');
            const ctrlA = document.getElementById('ctrl-a');
            const ctrlB = document.getElementById('ctrl-b');

            priceEl.innerText = state.currentPrice;

            // ë©”ì¸ ì´ë¯¸ì§€ í‘œì‹œ
            if (state.currentItem) {
                mainImg.src = state.currentItem;
                mainImg.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                mainImg.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }

            // ìƒíƒœ ë©”ì‹œì§€
            if (state.status === 'auction') {
                const bidder = state.currentBidder ? `${state.currentBidder}íŒ€` : 'ì…ì°° ëŒ€ê¸°';
                statusEl.innerHTML = `<span class="${state.currentBidder==='A'?'text-accentA':'text-accentB'}">${bidder}</span> ì…ì°° ì¤‘`;
                
                // í„´ì— ë”°ë¥¸ UI í™œì„±í™” (ë‚´ ì°¨ë¡€ì¼ ë•Œë§Œ)
                // ê·œì¹™: í˜„ì¬ ì…ì°°ìê°€ ì•„ë‹Œ ì‚¬ëŒì´ ì…ì°° ê°€ëŠ¥
                // ë‹¨, ì‹œì‘ ì§í›„(currentBidder=null)ëŠ” ë‘˜ ë‹¤ ê°€ëŠ¥
                const isMyTurn = (myRole === 'A' && state.currentBidder !== 'A') || 
                                 (myRole === 'B' && state.currentBidder !== 'B');
                
                ctrlA.style.opacity = (myRole === 'A' && isMyTurn) ? '1' : '0.3';
                ctrlA.style.pointerEvents = (myRole === 'A' && isMyTurn) ? 'auto' : 'none';
                
                ctrlB.style.opacity = (myRole === 'B' && isMyTurn) ? '1' : '0.3';
                ctrlB.style.pointerEvents = (myRole === 'B' && isMyTurn) ? 'auto' : 'none';

                // ì…ë ¥ì°½ íŒíŠ¸ ìë™ ì—…ë°ì´íŠ¸
                if(myRole === 'A') document.getElementById('input-a').value = state.currentPrice + 10;
                if(myRole === 'B') document.getElementById('input-b').value = state.currentPrice + 10;

            } else if (state.status === 'idle') {
                statusEl.innerText = "ë‹¤ìŒ ê²½ë§¤ ëŒ€ê¸°ì¤‘";
                ctrlA.style.opacity = '0.3'; ctrlA.style.pointerEvents = 'none';
                ctrlB.style.opacity = '0.3'; ctrlB.style.pointerEvents = 'none';
            }
        }

        function renderRoster(elementId, rosterArray) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            if (!rosterArray) return;
            rosterArray.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.className = "w-8 h-8 object-cover rounded border border-gray-600";
                container.appendChild(img);
            });
        }

        // =========================================================================
        // 5. ì•¡ì…˜ í•¨ìˆ˜ (Firebase ì“°ê¸°)
        // =========================================================================
        
        // ì´ë¯¸ì§€ ì—…ë¡œë“œ (Base64 ë³€í™˜ í›„ Firestore ì €ì¥)
        window.uploadImages = async (files) => {
            if (!files.length) return;
            // ê°„ë‹¨í•˜ê²Œ 1ê°œì”© ì²˜ë¦¬
            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64 = e.target.result;
                    // ë¬¸ì„œ ìš©ëŸ‰ ì œí•œì„ í”¼í•˜ê¸° ìœ„í•´ ì´ë¯¸ì§€ë¥¼ ë³„ë„ ì»¬ë ‰ì…˜ ë¬¸ì„œë¡œ ì €ì¥
                    await addDoc(collection(db, PUBLIC_PATH, 'images'), {
                        data: base64,
                        createdAt: serverTimestamp()
                    });
                };
                reader.readAsDataURL(files[i]);
            }
            sendSystemMessage("ìƒˆë¡œìš´ ì„ ìˆ˜ê°€ ëŒ€ê¸°ì‹¤ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

        // ê²½ë§¤ ì‹œì‘ (ë£°ë ›)
        window.startAuction = async () => {
            // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ì‹œì‘ ë¶ˆê°€
            if (!gameState.images || gameState.images.length === 0) {
                alert("ëŒ€ê¸°ì‹¤ì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤!"); return;
            }

            // DB ìƒíƒœ ë³€ê²½ -> 'rolling'
            // ì‹¤ì œ ì•„ì´í…œ ì„ ì •
            const randIdx = Math.floor(Math.random() * gameState.images.length);
            const selectedItem = gameState.images[randIdx];

            // íŠ¸ëœì­ì…˜ ëŒ€ì‹  ê°„ë‹¨í•œ update ì‚¬ìš©
            await updateDoc(doc(db, PUBLIC_PATH, 'game_state'), {
                status: 'rolling',
                rollingTarget: selectedItem, // ê²°ê³¼ ë¯¸ë¦¬ ì„ ì •
                timestamp: Date.now()
            });
        };

        // ë£°ë › íš¨ê³¼ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì—°ì¶œ)
        let isRolling = false;
        function handleRouletteEffect(data) {
            if (data.status === 'rolling' && !isRolling) {
                isRolling = true;
                const overlay = document.getElementById('roulette-overlay');
                const imgEl = document.getElementById('roulette-img');
                overlay.classList.remove('hidden');
                
                let count = 0;
                const maxCount = 20;
                const interval = setInterval(() => {
                    const r = Math.floor(Math.random() * gameState.images.length);
                    imgEl.src = gameState.images[r];
                    count++;
                    if (count >= maxCount) {
                        clearInterval(interval);
                        // ì—°ì¶œ ë, ì‹¤ì œ ê²½ë§¤ ìƒíƒœë¡œ ì „í™˜ (ì´ê±´ íŠ¸ë¦¬ê±°í•œ ì‚¬ëŒì´ í•˜ê±°ë‚˜, íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì²˜ë¦¬)
                        // ì—¬ê¸°ì„œëŠ” ë¡œì»¬ì—ì„œ ì—°ì¶œì´ ëë‚˜ë©´ UIë§Œ ì •ë¦¬í•˜ê³ , 
                        // **ëˆ„êµ°ê°€ í•œ ëª…(ë³´í†µ ì‹œì‘ ëˆ„ë¥¸ ì‚¬ëŒ)**ì´ DBë¥¼ updateí•´ì¤˜ì•¼ í•¨.
                        // ë™ê¸°í™” ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•´ 'rolling' ìƒíƒœë¥¼ 3ì´ˆ ìœ ì§€í•˜ê³ 
                        // ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ê°€ 3ì´ˆ ë’¤ì— 'rolling' ìƒíƒœë©´ -> ì•Œì•„ì„œ ì˜¤ë²„ë ˆì´ ë„ëŠ” ë°©ì‹ì´ ë‚˜ìŒ.
                        // í•˜ì§€ë§Œ DB ì—…ë°ì´íŠ¸ ê¶Œí•œì€ 'rolling'ì„ ì‹œì‘í•œ ì‚¬ëŒì—ê²Œ ì£¼ê±°ë‚˜ ë¦¬ë”ì—ê²Œ ì¤Œ.
                        
                        setTimeout(() => {
                           finishRolling(data.rollingTarget);
                        }, 500);
                    }
                }, 100);
            }
        }

        async function finishRolling(targetItem) {
            // ì˜¤ë²„ë ˆì´ ë„ê¸°
            document.getElementById('roulette-overlay').classList.add('hidden');
            isRolling = false;

            // ë‚´ê°€ ë¦¬ë”A ì´ê±°ë‚˜ (ë¦¬ë”Aê°€ ì—†ìœ¼ë©´ ë¦¬ë”Bê°€) ìƒíƒœ ì—…ë°ì´íŠ¸ ì´ëŒ€ ë©¤
            // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ë¥¼ ìœ„í•´ í˜„ì¬ ìƒíƒœê°€ ì•„ì§ 'rolling'ì¸ì§€ ì²´í¬ëŠ” ì„œë²„ì‚¬ì´ë“œ ë£°ì´ ì—†ìœ¼ë©´ í˜ë“¤ì§€ë§Œ
            // ì—¬ê¸°ì„  ê°„ë‹¨íˆ AíŒ€ì¥ì´ ìˆ˜í–‰ (Aì—†ìœ¼ë©´ B)
            if ( (myRole === 'A') || (myRole === 'B' && !gameState.teams.A.leader) ) {
                 // ëŒ€ê¸°ì‹¤ì—ì„œ ì´ë¯¸ì§€ ì œê±°í•´ì•¼ í•¨ (Queryë¡œ ì°¾ì•„ì„œ ì§€ì›Œì•¼ í•˜ëŠ”ë° Base64ë¼ ë§¤ì¹­ì´ ì–´ë ¤ì›€)
                 // *ì•½ì‹ êµ¬í˜„*: ì—¬ê¸°ì„œëŠ” ëŒ€ê¸°ì‹¤ ì´ë¯¸ì§€ë¥¼ ì§€ìš°ì§€ ì•Šê³  ë³µì‚¬ë³¸ì„ ì”€ (ê²Œì„ ë‹¨ìˆœí™”)
                 
                 await updateDoc(doc(db, PUBLIC_PATH, 'game_state'), {
                    status: 'auction',
                    currentItem: targetItem,
                    currentPrice: 10,
                    currentBidder: null
                });
            }
        }

        // ì…ì°°
        window.placeBid = async (team) => {
            const inputId = team === 'A' ? 'input-a' : 'input-b';
            const bidAmount = parseInt(document.getElementById(inputId).value);
            const myTeamMoney = gameState.teams[team].money;

            if (bidAmount > myTeamMoney) { alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return; }
            if (bidAmount <= gameState.currentPrice) { alert("í˜„ì¬ê°€ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤."); return; }

            await updateDoc(doc(db, PUBLIC_PATH, 'game_state'), {
                currentPrice: bidAmount,
                currentBidder: team
            });
            sendSystemMessage(`${team}íŒ€ì´ ${bidAmount}ì›ì— ì…ì°°í–ˆìŠµë‹ˆë‹¤!`);
        };

        // í¬ê¸° (ë„˜ê¸°ê¸°) -> ìƒëŒ€ë°© ë‚™ì°°
        window.passTurn = async (team) => {
            if (!confirm("ì •ë§ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìƒëŒ€ì—ê²Œ ë‚™ì°°ë©ë‹ˆë‹¤.")) return;
            
            const opponent = team === 'A' ? 'B' : 'A';
            const price = gameState.currentPrice;
            const item = gameState.currentItem;

            // ë‚™ì°° ë¡œì§ (ëˆ ì°¨ê°, ë¡œìŠ¤í„° ì¶”ê°€)
            // ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•´ì„  Transactionì´ í•„ìš”í•˜ì§€ë§Œ ì—¬ê¸°ì„  ê°„ë‹¨íˆ
            const updates = {};
            updates[`${opponent}.money`] = gameState.teams[opponent].money - price;
            updates[`${opponent}.roster`] = arrayUnion(item);

            await updateDoc(doc(db, PUBLIC_PATH, 'teams'), updates);
            
            // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
            await updateDoc(doc(db, PUBLIC_PATH, 'game_state'), {
                status: 'idle',
                currentBidder: null,
                currentItem: null,
                currentPrice: 10
            });

            sendSystemMessage(`ğŸ‰ [ë‚™ì°°] ${opponent}íŒ€ì´ ${price}ì›ì— ì˜ì… ì„±ê³µ!`);
        };

        // ì±„íŒ… ì „ì†¡
        window.sendChat = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            const senderName = myRole === 'A' ? 'AíŒ€ì¥' : (myRole === 'B' ? 'BíŒ€ì¥' : 'ê´€ì „ì');
            
            await addDoc(collection(db, PUBLIC_PATH, 'chat'), {
                sender: senderName,
                role: myRole || 'spectator',
                text: text,
                type: 'msg',
                timestamp: serverTimestamp()
            });
            input.value = '';
        };

        async function sendSystemMessage(text) {
            await addDoc(collection(db, PUBLIC_PATH, 'chat'), {
                text: text,
                type: 'system',
                timestamp: serverTimestamp()
            });
        }

        // ê²Œì„ ì´ˆê¸°í™” (Reset)
        window.resetGame = async () => {
            if (!confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (íŒ€ì›, ëˆ, ëŒ€ê¸°ì‹¤ ë“±)")) return;
            
            // 1. íŒ€ ì •ë³´ ë¦¬ì…‹
            await setDoc(doc(db, PUBLIC_PATH, 'teams'), {
                A: { money: 1000, roster: [], leader: null },
                B: { money: 1000, roster: [], leader: null }
            });
            // 2. ê²Œì„ ìƒíƒœ ë¦¬ì…‹
            await setDoc(doc(db, PUBLIC_PATH, 'game_state'), {
                status: 'idle',
                currentPrice: 10,
                currentBidder: null,
                currentItem: null
            });
            // 3. ì±„íŒ… ë¦¬ì…‹ (ì»¬ë ‰ì…˜ ì‚­ì œëŠ” í´ë¼ì´ì–¸íŠ¸ SDKì—ì„œ ì–´ë ¤ìš°ë¯€ë¡œ ë¬´ì‹œí•˜ê±°ë‚˜ ê´€ë¦¬ì ê¸°ëŠ¥ í•„ìš”)
            // ì—¬ê¸°ì„  ìƒëµ
            
            alert("ì´ˆê¸°í™” ì™„ë£Œ. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.");
            location.reload();
        };

    </script>
</body>
</html>