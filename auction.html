<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¨ë¼ì¸ ê²½ë§¤ ì‹œìŠ¤í…œ</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#1a1a1a',
                        panel: '#2d2d2d',
                        accentA: '#ff6b6b',
                        accentB: '#4dabf7',
                        highlight: '#ffd43b'
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #1a1a1a; color: #e0e0e0; overflow: hidden; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #ffd43b; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ (ì—­í•  ì„ íƒ) -->
    <div id="login-modal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center">
        <div class="bg-panel p-8 rounded-xl max-w-md w-full text-center border border-gray-700 shadow-2xl">
            <h2 class="text-3xl font-bold text-highlight mb-6">ğŸ² ì˜¨ë¼ì¸ ê²½ë§¤ ì…ì¥</h2>
            <div class="space-y-4">
                <button onclick="selectRole('A')" class="w-full py-4 bg-accentA/20 hover:bg-accentA/40 border-2 border-accentA text-accentA rounded-lg font-bold transition flex justify-between px-6 items-center">
                    <span>ğŸ”´ AíŒ€ íŒ€ì¥ìœ¼ë¡œ ì…ì¥</span>
                    <span id="status-a" class="text-xs bg-black/50 px-2 py-1 rounded">ëŒ€ê¸°ì¤‘</span>
                </button>
                <button onclick="selectRole('B')" class="w-full py-4 bg-accentB/20 hover:bg-accentB/40 border-2 border-accentB text-accentB rounded-lg font-bold transition flex justify-between px-6 items-center">
                    <span>ğŸ”µ BíŒ€ íŒ€ì¥ìœ¼ë¡œ ì…ì¥</span>
                    <span id="status-b" class="text-xs bg-black/50 px-2 py-1 rounded">ëŒ€ê¸°ì¤‘</span>
                </button>
                <div class="h-px bg-gray-600 my-4"></div>
                <button onclick="selectRole('spectator')" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-bold transition">
                    ğŸ‘€ ê´€ì „ìë¡œ ì…ì¥
                </button>
            </div>
            <p class="mt-6 text-xs text-gray-500">* Firebase ì—°ê²° ëŒ€ê¸° ì¤‘...</p>
        </div>
    </div>

    <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
    <header class="bg-black border-b border-gray-700 h-14 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-gavel text-highlight"></i>
            <span class="font-bold text-lg">Auction Online</span>
        </div>
        <div class="flex items-center gap-4 text-sm">
            <span id="my-role-display" class="px-3 py-1 rounded bg-gray-800 border border-gray-600">ì ‘ì†ì¤‘...</span>
            <button onclick="resetGame()" class="text-red-400 hover:text-red-300 text-xs underline">âš ï¸ ê²Œì„ ì´ˆê¸°í™”</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- ì™¼ìª½: ëŒ€ê¸°ì‹¤ (ì´ë¯¸ì§€ ê´€ë¦¬) -->
        <div class="w-1/5 bg-panel border-r border-gray-700 flex flex-col p-4">
            <h3 class="font-bold mb-4 flex justify-between items-center">
                <span>ğŸ“‚ ëŒ€ê¸°ì‹¤</span>
                <span id="waiting-count" class="text-xs bg-gray-700 px-2 py-1 rounded">0</span>
            </h3>
            
            <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
            <div class="mb-4">
                <input type="file" id="fileInput" multiple accept="image/*" class="hidden" onchange="uploadImages(this.files)">
                <button onclick="document.getElementById('fileInput').click()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm transition">
                    <i class="fa-solid fa-cloud-arrow-up"></i> ì‚¬ì§„ ì¶”ê°€
                </button>
            </div>

            <div id="waiting-grid" class="flex-1 overflow-y-auto grid grid-cols-2 gap-2 content-start pr-1">
                <!-- ì´ë¯¸ì§€ ì¸ë„¤ì¼ -->
            </div>
        </div>

        <!-- ì¤‘ì•™: ê²½ë§¤ ìŠ¤í…Œì´ì§€ -->
        <div class="w-1/2 bg-dark flex flex-col relative">
            <!-- ë©”ì¸ í™”ë©´ -->
            <div class="flex-1 flex flex-col justify-center items-center p-8">
                <div class="relative w-80 h-80 bg-black rounded-2xl border-4 border-gray-600 shadow-2xl overflow-hidden flex justify-center items-center mb-6">
                    <img id="main-display" src="" class="w-full h-full object-cover hidden">
                    <div id="placeholder-text" class="text-gray-500 text-center">
                        <i class="fa-solid fa-image text-4xl mb-2"></i><br>ê²½ë§¤ ëŒ€ê¸°ì¤‘
                    </div>
                    <!-- ë£°ë › ì• ë‹ˆë©”ì´ì…˜ìš© ì˜¤ë²„ë ˆì´ -->
                    <div id="roulette-overlay" class="absolute inset-0 bg-black flex justify-center items-center hidden z-10">
                        <img id="roulette-img" class="w-full h-full object-cover opacity-80">
                    </div>
                </div>

                <div class="text-center space-y-2">
                    <div class="text-gray-400 text-sm">í˜„ì¬ ê°€ê²©</div>
                    <div class="text-5xl font-bold text-highlight drop-shadow-lg"><span id="current-price">0</span>ì›</div>
                    <div id="auction-status" class="h-6 text-sm text-gray-500">ì‹œì‘ ì „</div>
                </div>

                <!-- ê²½ë§¤ ì‹œì‘ ë²„íŠ¼ -->
                <button id="btn-start" onclick="startAuction()" class="mt-8 px-8 py-3 bg-highlight text-black font-bold rounded-full hover:bg-yellow-400 transition hidden shadow-lg shadow-yellow-500/20">
                    START AUCTION
                </button>
            </div>

            <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ (í•˜ë‹¨) -->
            <div class="h-48 border-t border-gray-700 flex">
                <!-- AíŒ€ ì»¨íŠ¸ë¡¤ -->
                <div id="ctrl-a" class="flex-1 bg-gradient-to-t from-red-900/20 to-transparent p-4 flex flex-col items-center justify-center opacity-30 pointer-events-none transition-all duration-300">
                    <h4 class="text-accentA font-bold mb-2">TEAM A</h4>
                    <input type="number" id="input-a" class="bg-gray-800 border border-gray-600 rounded p-2 w-32 text-center mb-2 text-white" placeholder="ê¸ˆì•¡">
                    <div class="flex gap-2">
                        <button onclick="placeBid('A')" class="px-4 py-2 bg-accentA text-white rounded font-bold hover:brightness-110">ì…ì°°</button>
                        <button onclick="passTurn('A')" class="px-4 py-2 bg-gray-600 text-white rounded font-bold hover:bg-gray-500">í¬ê¸°</button>
                    </div>
                </div>
                <!-- BíŒ€ ì»¨íŠ¸ë¡¤ -->
                <div id="ctrl-b" class="flex-1 bg-gradient-to-t from-blue-900/20 to-transparent p-4 flex flex-col items-center justify-center opacity-30 pointer-events-none transition-all duration-300">
                    <h4 class="text-accentB font-bold mb-2">TEAM B</h4>
                    <input type="number" id="input-b" class="bg-gray-800 border border-gray-600 rounded p-2 w-32 text-center mb-2 text-white" placeholder="ê¸ˆì•¡">
                    <div class="flex gap-2">
                        <button onclick="placeBid('B')" class="px-4 py-2 bg-accentB text-white rounded font-bold hover:brightness-110">ì…ì°°</button>
                        <button onclick="passTurn('B')" class="px-4 py-2 bg-gray-600 text-white rounded font-bold hover:bg-gray-500">í¬ê¸°</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì •ë³´ ë° ì±„íŒ… -->
        <div class="w-[30%] bg-panel border-l border-gray-700 flex flex-col p-4">
            <!-- íŒ€ í˜„í™© -->
            <div class="space-y-4 mb-4">
                <div class="bg-dark p-3 rounded-lg border-l-4 border-accentA">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-accentA">Team A</span>
                        <span id="money-a" class="font-mono">1000ì›</span>
                    </div>
                    <div id="roster-a" class="flex flex-wrap gap-1 h-16 overflow-y-auto content-start"></div>
                </div>
                <div class="bg-dark p-3 rounded-lg border-l-4 border-accentB">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-accentB">Team B</span>
                        <span id="money-b" class="font-mono">1000ì›</span>
                    </div>
                    <div id="roster-b" class="flex flex-wrap gap-1 h-16 overflow-y-auto content-start"></div>
                </div>
            </div>

            <!-- ì±„íŒ… -->
            <div class="flex-1 bg-black rounded-lg border border-gray-700 flex flex-col overflow-hidden">
                <div id="chat-box" class="flex-1 overflow-y-auto p-3 text-sm space-y-1"></div>
                <form onsubmit="sendChat(event)" class="flex border-t border-gray-700">
                    <input type="text" id="chat-input" class="flex-1 bg-transparent p-3 outline-none text-white placeholder-gray-600" placeholder="ì±„íŒ… ì…ë ¥...">
                    <button type="submit" class="px-4 bg-gray-800 hover:bg-gray-700 text-gray-300 transition">ì „ì†¡</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, arrayUnion, arrayRemove, collection, addDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // 1. Firebase ì„¤ì •
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAYyjK1qwPObsSXFSEmnye64iTFvcIY1Lg",
            authDomain: "auction-dfc5c.firebaseapp.com",
            projectId: "auction-dfc5c",
            storageBucket: "auction-dfc5c.firebasestorage.app",
            messagingSenderId: "422510640786",
            appId: "1:422510640786:web:7fdd804b61ac401408b04b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // [ì¤‘ìš”] ê²½ë¡œ ìƒìˆ˜ ìˆ˜ì •: ì§ìˆ˜ ë ˆë²¨(6ë‹¨ê³„) ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ë² ì´ìŠ¤
        // ê¸°ì¡´ ì½”ë“œì˜ 'public/data' (4ë‹¨ê³„) ë’¤ì— ì»¬ë ‰ì…˜ê³¼ ë¬¸ì„œIDë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë¶™ì—¬ì„œ ì‚¬ìš©
        const BASE_PATH_PREFIX = `artifacts/auction-room-01/public/data`;
        
        // ì „ì—­ ìƒíƒœ
        let myRole = null; 
        let myUid = null;
        let gameState = { teams: { A: {}, B: {} } };

        // ë¬¸ì„œ ì°¸ì¡° í—¬í¼ í•¨ìˆ˜ (ê²½ë¡œ ì˜¤ë¥˜ ë°©ì§€ìš©)
        // artifacts(c) -> room(d) -> public(c) -> data(d) -> teams(c) -> general(d) [6ë‹¨ê³„]
        const getTeamsRef = () => doc(db, BASE_PATH_PREFIX, 'teams', 'general');
        const getGameStateRef = () => doc(db, BASE_PATH_PREFIX, 'game_state', 'general');

        // =========================================================================
        // 2. ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ ë¡œì§
        // =========================================================================
        async function init() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        myUid = user.uid;
                        console.log("Logged in:", myUid);
                        setupListeners();
                    }
                });
            } catch (e) {
                console.error("Auth Error:", e);
                alert("Firebase ì—°ê²° ì‹¤íŒ¨. ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
            }
        }
        init();

        window.selectRole = async (role) => {
            if (!myUid) return alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            
            // ì—­í•  ì ìœ  í™•ì¸
            if (role === 'A' && gameState.teams?.A?.leader && gameState.teams.A.leader !== myUid) {
                alert("AíŒ€ì¥ì€ ì´ë¯¸ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤."); return;
            }
            if (role === 'B' && gameState.teams?.B?.leader && gameState.teams.B.leader !== myUid) {
                alert("BíŒ€ì¥ì€ ì´ë¯¸ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤."); return;
            }

            myRole = role;
            document.getElementById('login-modal').classList.add('hidden');
            const roleName = role === 'A' ? 'ğŸ”´ AíŒ€ì¥' : (role === 'B' ? 'ğŸ”µ BíŒ€ì¥' : 'ğŸ‘€ ê´€ì „ì');
            document.getElementById('my-role-display').innerText = roleName;

            if (role !== 'spectator') {
                const updates = {};
                if (role === 'A') updates["A.leader"] = myUid;
                if (role === 'B') updates["B.leader"] = myUid;

                // ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì‹œë„, ì—†ìœ¼ë©´ ìƒì„±
                await updateDoc(getTeamsRef(), updates).catch(async () => {
                     await setDoc(getTeamsRef(), {
                        A: { money: 1000, roster: [], leader: role === 'A' ? myUid : null },
                        B: { money: 1000, roster: [], leader: role === 'B' ? myUid : null }
                     }, { merge: true });
                });
            }
            sendSystemMessage(`${roleName}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
        };

        // =========================================================================
        // 3. ë¦¬ìŠ¤ë„ˆ (ë°ì´í„° ë™ê¸°í™”)
        // =========================================================================
        function setupListeners() {
            // (1) ê²Œì„ ìƒíƒœ
            onSnapshot(getGameStateRef(), (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                gameState.status = data.status; 
                gameState.currentPrice = data.currentPrice;
                gameState.currentBidder = data.currentBidder;
                gameState.currentItem = data.currentItem;
                
                renderGameUI(data);
                handleRouletteEffect(data);
            });

            // (2) íŒ€ ì •ë³´
            onSnapshot(getTeamsRef(), (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                gameState.teams = data;
                
                document.getElementById('money-a').innerText = (data.A?.money || 0) + 'ì›';
                document.getElementById('money-b').innerText = (data.B?.money || 0) + 'ì›';
                renderRoster('roster-a', data.A?.roster);
                renderRoster('roster-b', data.B?.roster);

                const statusA = document.getElementById('status-a');
                const statusB = document.getElementById('status-b');
                if(statusA) statusA.innerText = data.A?.leader ? 'ì ‘ì†ì¤‘' : 'ëŒ€ê¸°ì¤‘';
                if(statusB) statusB.innerText = data.B?.leader ? 'ì ‘ì†ì¤‘' : 'ëŒ€ê¸°ì¤‘';

                // ì‹œì‘ ë²„íŠ¼ í‘œì‹œ ë¡œì§
                const bothReady = data.A?.leader && data.B?.leader;
                const btnStart = document.getElementById('btn-start');
                if (bothReady && gameState.status === 'idle') {
                    btnStart.classList.remove('hidden');
                } else {
                    btnStart.classList.add('hidden');
                }
            });

            // (3) ëŒ€ê¸°ì‹¤ ì´ë¯¸ì§€ (ì»¬ë ‰ì…˜ ì¡°íšŒ)
            const qImages = query(collection(db, BASE_PATH_PREFIX, 'images'), orderBy('createdAt'));
            onSnapshot(qImages, (snap) => {
                const grid = document.getElementById('waiting-grid');
                grid.innerHTML = '';
                gameState.images = [];
                snap.forEach(docSnap => {
                    const imgData = docSnap.data();
                    gameState.images.push(imgData.data);
                    const img = document.createElement('img');
                    img.src = imgData.data;
                    img.className = "w-full aspect-square object-cover rounded border border-gray-600 bg-black";
                    grid.appendChild(img);
                });
                document.getElementById('waiting-count').innerText = gameState.images.length;
            });

            // (4) ì±„íŒ…
            const qChat = query(collection(db, BASE_PATH_PREFIX, 'chat'), orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(qChat, (snap) => {
                const box = document.getElementById('chat-box');
                box.innerHTML = '';
                const messages = [];
                snap.forEach(d => messages.push(d.data()));
                messages.reverse().forEach(msg => {
                    const div = document.createElement('div');
                    if (msg.type === 'system') {
                        div.className = "text-yellow-500 italic text-xs text-center my-2";
                        div.innerText = `ğŸ“¢ ${msg.text}`;
                    } else {
                        const color = msg.role === 'A' ? 'text-accentA' : (msg.role === 'B' ? 'text-accentB' : 'text-gray-400');
                        div.innerHTML = `<span class="font-bold ${color}">${msg.sender}:</span> ${msg.text}`;
                    }
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // =========================================================================
        // 4. UI ë Œë”ë§
        // =========================================================================
        function renderGameUI(state) {
            const priceEl = document.getElementById('current-price');
            const statusEl = document.getElementById('auction-status');
            const mainImg = document.getElementById('main-display');
            const placeholder = document.getElementById('placeholder-text');
            const ctrlA = document.getElementById('ctrl-a');
            const ctrlB = document.getElementById('ctrl-b');

            priceEl.innerText = state.currentPrice;

            if (state.currentItem) {
                mainImg.src = state.currentItem;
                mainImg.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                mainImg.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }

            if (state.status === 'auction') {
                const bidder = state.currentBidder ? `${state.currentBidder}íŒ€` : 'ì…ì°° ëŒ€ê¸°';
                statusEl.innerHTML = `<span class="${state.currentBidder==='A'?'text-accentA':'text-accentB'}">${bidder}</span> ì…ì°° ì¤‘`;
                
                const isMyTurn = (myRole === 'A' && state.currentBidder !== 'A') || 
                                 (myRole === 'B' && state.currentBidder !== 'B');
                const canBid = isMyTurn || state.currentBidder === null;

                ctrlA.style.opacity = (myRole === 'A' && canBid) ? '1' : '0.3';
                ctrlA.style.pointerEvents = (myRole === 'A' && canBid) ? 'auto' : 'none';
                ctrlB.style.opacity = (myRole === 'B' && canBid) ? '1' : '0.3';
                ctrlB.style.pointerEvents = (myRole === 'B' && canBid) ? 'auto' : 'none';

                if(myRole === 'A' && canBid) document.getElementById('input-a').value = state.currentPrice + 10;
                if(myRole === 'B' && canBid) document.getElementById('input-b').value = state.currentPrice + 10;

            } else {
                statusEl.innerText = state.status === 'rolling' ? "ì¶”ì²¨ ì¤‘..." : "ë‹¤ìŒ ê²½ë§¤ ëŒ€ê¸°ì¤‘";
                ctrlA.style.opacity = '0.3'; ctrlA.style.pointerEvents = 'none';
                ctrlB.style.opacity = '0.3'; ctrlB.style.pointerEvents = 'none';
            }
        }

        function renderRoster(elementId, rosterArray) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            if (!rosterArray) return;
            rosterArray.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.className = "w-8 h-8 object-cover rounded border border-gray-600";
                container.appendChild(img);
            });
        }

        // =========================================================================
        // 5. ì•¡ì…˜ í•¨ìˆ˜
        // =========================================================================
        window.uploadImages = async (files) => {
            if (!files.length) return;
            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    await addDoc(collection(db, BASE_PATH_PREFIX, 'images'), {
                        data: e.target.result,
                        createdAt: serverTimestamp()
                    });
                };
                reader.readAsDataURL(files[i]);
            }
            sendSystemMessage("ìƒˆë¡œìš´ ì„ ìˆ˜ê°€ ëŒ€ê¸°ì‹¤ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

        window.startAuction = async () => {
            if (!gameState.images || gameState.images.length === 0) {
                alert("ëŒ€ê¸°ì‹¤ì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤!"); return;
            }
            const randIdx = Math.floor(Math.random() * gameState.images.length);
            const selectedItem = gameState.images[randIdx];

            await updateDoc(getGameStateRef(), {
                status: 'rolling',
                rollingTarget: selectedItem,
                timestamp: Date.now()
            });
        };

        let isRolling = false;
        function handleRouletteEffect(data) {
            if (data.status === 'rolling' && !isRolling) {
                isRolling = true;
                const overlay = document.getElementById('roulette-overlay');
                const imgEl = document.getElementById('roulette-img');
                overlay.classList.remove('hidden');
                
                let count = 0;
                const interval = setInterval(() => {
                    const r = Math.floor(Math.random() * gameState.images.length);
                    imgEl.src = gameState.images[r];
                    count++;
                    if (count >= 20) {
                        clearInterval(interval);
                        setTimeout(() => { finishRolling(data.rollingTarget); }, 500);
                    }
                }, 100);
            }
        }

        async function finishRolling(targetItem) {
            document.getElementById('roulette-overlay').classList.add('hidden');
            isRolling = false;
            
            // ë¦¬ë”A (ì—†ìœ¼ë©´ ë¦¬ë”B)ê°€ ìƒíƒœ ì—…ë°ì´íŠ¸
            const isLeaderA = myUid === gameState.teams.A?.leader;
            const isLeaderB = myUid === gameState.teams.B?.leader;
            const noLeaderA = !gameState.teams.A?.leader;

            if (isLeaderA || (noLeaderA && isLeaderB)) {
                 await updateDoc(getGameStateRef(), {
                    status: 'auction',
                    currentItem: targetItem,
                    currentPrice: 10,
                    currentBidder: null
                });
            }
        }

        window.placeBid = async (team) => {
            const inputId = team === 'A' ? 'input-a' : 'input-b';
            const bidAmount = parseInt(document.getElementById(inputId).value);
            const myTeamMoney = gameState.teams[team].money || 0;

            if (bidAmount > myTeamMoney) { alert("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return; }
            if (bidAmount <= gameState.currentPrice) { alert("í˜„ì¬ê°€ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤."); return; }

            await updateDoc(getGameStateRef(), {
                currentPrice: bidAmount,
                currentBidder: team
            });
            sendSystemMessage(`${team}íŒ€ì´ ${bidAmount}ì›ì— ì…ì°°í–ˆìŠµë‹ˆë‹¤!`);
        };

        window.passTurn = async (team) => {
            if (!confirm("ì •ë§ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìƒëŒ€ì—ê²Œ ë‚™ì°°ë©ë‹ˆë‹¤.")) return;
            
            const opponent = team === 'A' ? 'B' : 'A';
            const price = gameState.currentPrice;
            const item = gameState.currentItem;

            // ë‚™ì°° ì²˜ë¦¬
            const updates = {};
            updates[`${opponent}.money`] = (gameState.teams[opponent].money || 0) - price;
            updates[`${opponent}.roster`] = arrayUnion(item);

            await updateDoc(getTeamsRef(), updates);
            
            // ìƒíƒœ ì´ˆê¸°í™”
            await updateDoc(getGameStateRef(), {
                status: 'idle',
                currentBidder: null,
                currentItem: null,
                currentPrice: 10
            });

            sendSystemMessage(`ğŸ‰ [ë‚™ì°°] ${opponent}íŒ€ì´ ${price}ì›ì— ì˜ì… ì„±ê³µ!`);
        };

        window.sendChat = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            await addDoc(collection(db, BASE_PATH_PREFIX, 'chat'), {
                sender: myRole === 'A' ? 'AíŒ€ì¥' : (myRole === 'B' ? 'BíŒ€ì¥' : 'ê´€ì „ì'),
                role: myRole || 'spectator',
                text: text,
                type: 'msg',
                timestamp: serverTimestamp()
            });
            input.value = '';
        };

        async function sendSystemMessage(text) {
            await addDoc(collection(db, BASE_PATH_PREFIX, 'chat'), {
                text: text,
                type: 'system',
                timestamp: serverTimestamp()
            });
        }

        window.resetGame = async () => {
            if (!confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (íŒ€ì›, ëˆ, ëŒ€ê¸°ì‹¤ ë“±)")) return;
            
            await setDoc(getTeamsRef(), {
                A: { money: 1000, roster: [], leader: null },
                B: { money: 1000, roster: [], leader: null }
            });
            await setDoc(getGameStateRef(), {
                status: 'idle',
                currentPrice: 10,
                currentBidder: null,
                currentItem: null
            });
            
            alert("ì´ˆê¸°í™” ì™„ë£Œ. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.");
            location.reload();
        };

    </script>
</body>
</html>
